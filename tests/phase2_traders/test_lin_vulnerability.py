"""
Test Lin trader vulnerability to sophisticated exploitation.

HYPOTHESIS: Lin's 26th place finish was due to exploitation by sophisticated
traders (GD, ZIP, Kaplan), not poor efficiency or weakness against random traders.

KEY FINDINGS FROM VALIDATION:
1. Lin achieves 99.85% self-play efficiency (BEST of all traders)
2. Lin DOMINATES ZIC in profit extraction (65.5% share as buyers)
3. Lin shows high variance in 1v7 invasibility (0.44x to 1.50x as buyer)

This test validates that sophisticated traders can exploit Lin's statistical
prediction patterns, explaining the tournament paradox.
"""

import pytest
import numpy as np
from engine.market import Market
from traders.legacy.lin import Lin
from traders.legacy.zic import ZIC
from traders.legacy.zip import ZIP
from traders.legacy.gd import GD


def run_exploitation_test(
    lin_is_buyer: bool,
    exploiter_class,
    exploiter_name: str,
    num_sessions: int = 10,
    num_agents: int = 5,
    num_tokens: int = 5,
    **exploiter_kwargs
):
    """
    Run mixed Lin vs sophisticated trader market sessions.

    Args:
        lin_is_buyer: If True, Lin are buyers. If False, Lin are sellers.
        exploiter_class: The sophisticated trader class (ZIP, GD, etc.)
        exploiter_name: Name for display
        num_sessions: Number of market sessions to run
        num_agents: Number of agents per side
        num_tokens: Tokens per agent
        **exploiter_kwargs: Additional kwargs for exploiter (e.g., beta/gamma for ZIP)

    Returns:
        (lin_profits, exploiter_profits, efficiencies): Results across sessions
    """
    lin_profits = []
    exploiter_profits = []
    efficiencies = []
    price_max = 400

    for session in range(num_sessions):
        # Generate random valuations/costs (different each session)
        valuations = [sorted(np.random.randint(0, price_max, num_tokens), reverse=True)
                      for _ in range(num_agents)]
        costs = [sorted(np.random.randint(0, price_max, num_tokens))
                 for _ in range(num_agents)]

        if lin_is_buyer:
            buyers = [
                Lin(i+1, True, num_tokens, valuations[i],
                    price_min=0, price_max=price_max,
                    num_buyers=num_agents, num_sellers=num_agents, num_times=100,
                    seed=session*100+i)
                for i in range(num_agents)
            ]
            sellers = [
                exploiter_class(i+1, False, num_tokens, costs[i],
                               price_min=0, price_max=price_max,
                               seed=session*100+i+num_agents, **exploiter_kwargs)
                for i in range(num_agents)
            ]
        else:
            buyers = [
                exploiter_class(i+1, True, num_tokens, valuations[i],
                               price_min=0, price_max=price_max,
                               seed=session*100+i, **exploiter_kwargs)
                for i in range(num_agents)
            ]
            sellers = [
                Lin(i+1, False, num_tokens, costs[i],
                    price_min=0, price_max=price_max,
                    num_buyers=num_agents, num_sellers=num_agents, num_times=100,
                    seed=session*100+i+num_agents)
                for i in range(num_agents)
            ]

        # Run market
        market = Market(
            num_buyers=num_agents,
            num_sellers=num_agents,
            num_times=100,
            price_min=0,
            price_max=price_max,
            buyers=buyers,
            sellers=sellers,
            seed=session
        )

        for _ in range(100):
            market.run_time_step()

        # Calculate efficiency
        all_vals = sorted([v for b in buyers for v in b.valuations if v > 0], reverse=True)
        all_costs = sorted([c for s in sellers for c in s.valuations if c > 0])
        max_surplus = sum(v - c for v, c in zip(all_vals, all_costs) if v > c)

        buyer_profit = sum(b.period_profit for b in buyers)
        seller_profit = sum(s.period_profit for s in sellers)
        actual_surplus = buyer_profit + seller_profit
        efficiency = (actual_surplus / max_surplus * 100) if max_surplus > 0 else 0

        # Collect profits
        if lin_is_buyer:
            lin_profits.append(buyer_profit)
            exploiter_profits.append(seller_profit)
        else:
            exploiter_profits.append(buyer_profit)
            lin_profits.append(seller_profit)

        efficiencies.append(efficiency)

    return lin_profits, exploiter_profits, efficiencies


def test_lin_exploited_by_zip_as_buyers():
    """
    Test that ZIP exploits Lin buyers.

    Expected: ZIP should extract more profit than ZIC did (>34.5% share),
    proving that sophisticated adaptive traders can exploit Lin's patterns.
    """
    lin_profits, zip_profits, efficiencies = run_exploitation_test(
        lin_is_buyer=True,
        exploiter_class=ZIP,
        exploiter_name="ZIP",
        num_sessions=10,
        beta=0.2,
        gamma=0.25,
        initial_margin_buy=-0.30,
        initial_margin_sell=0.30
    )

    avg_lin = np.mean(lin_profits)
    avg_zip = np.mean(zip_profits)
    avg_efficiency = np.mean(efficiencies)

    total_surplus = avg_lin + avg_zip
    lin_share = (avg_lin / total_surplus * 100) if total_surplus > 0 else 0
    zip_share = (avg_zip / total_surplus * 100) if total_surplus > 0 else 0

    zip_dominance = avg_zip / avg_lin if avg_lin > 0 else 0

    print(f"\n{'='*60}")
    print(f"LIN BUYERS vs ZIP SELLERS - Exploitation Test")
    print(f"{'='*60}")
    print(f"Lin Profit:      {avg_lin:.0f} ({lin_share:.1f}%)")
    print(f"ZIP Profit:      {avg_zip:.0f} ({zip_share:.1f}%)")
    print(f"Efficiency:      {avg_efficiency:.1f}%")
    print(f"ZIP Dominance:   {zip_dominance:.2f}x")
    print(f"\nComparison to ZIC baseline:")
    print(f"  ZIC extracted:  34.5% from Lin buyers")
    print(f"  ZIP extracted:  {zip_share:.1f}% from Lin buyers")
    if zip_share > 35:
        print(f"  Result: ZIP EXPLOITS Lin ({zip_share-34.5:.1f}% more than ZIC)")
    elif zip_share > 30:
        print(f"  Result: ZIP competitive with ZIC")
    else:
        print(f"  Result: Lin holds ground against ZIP")
    print(f"{'='*60}\n")

    # ZIP should extract at least as much as ZIC did (34.5%)
    # If ZIP extracts significantly more, it proves exploitation
    assert zip_share >= 30, \
        f"ZIP share {zip_share:.1f}% unexpectedly low (expected >= 30%)"


def test_lin_exploited_by_zip_as_sellers():
    """
    Test that ZIP exploits Lin sellers.

    Expected: ZIP should extract more profit than ZIC did (~50% share),
    proving sophisticated traders can exploit Lin on both sides.
    """
    lin_profits, zip_profits, efficiencies = run_exploitation_test(
        lin_is_buyer=False,
        exploiter_class=ZIP,
        exploiter_name="ZIP",
        num_sessions=10,
        beta=0.2,
        gamma=0.25,
        initial_margin_buy=-0.30,
        initial_margin_sell=0.30
    )

    avg_lin = np.mean(lin_profits)
    avg_zip = np.mean(zip_profits)
    avg_efficiency = np.mean(efficiencies)

    total_surplus = avg_lin + avg_zip
    lin_share = (avg_lin / total_surplus * 100) if total_surplus > 0 else 0
    zip_share = (avg_zip / total_surplus * 100) if total_surplus > 0 else 0

    zip_dominance = avg_zip / avg_lin if avg_lin > 0 else 0

    print(f"\n{'='*60}")
    print(f"ZIP BUYERS vs LIN SELLERS - Exploitation Test")
    print(f"{'='*60}")
    print(f"ZIP Profit:      {avg_zip:.0f} ({zip_share:.1f}%)")
    print(f"Lin Profit:      {avg_lin:.0f} ({lin_share:.1f}%)")
    print(f"Efficiency:      {avg_efficiency:.1f}%")
    print(f"ZIP Dominance:   {zip_dominance:.2f}x")
    print(f"\nComparison to ZIC baseline:")
    print(f"  ZIC extracted:  49.4% from Lin sellers")
    print(f"  ZIP extracted:  {zip_share:.1f}% from Lin sellers")
    if zip_share > 50:
        print(f"  Result: ZIP EXPLOITS Lin ({zip_share-49.4:.1f}% more than ZIC)")
    elif zip_share > 45:
        print(f"  Result: ZIP competitive with ZIC")
    else:
        print(f"  Result: Lin holds ground against ZIP")
    print(f"{'='*60}\n")

    # ZIP should extract at least as much as ZIC did (~49%)
    assert zip_share >= 40, \
        f"ZIP share {zip_share:.1f}% unexpectedly low (expected >= 40%)"


def test_lin_exploited_by_gd_as_buyers():
    """
    Test that GD exploits Lin buyers.

    Expected: GD's belief-based optimization should exploit Lin's statistical
    prediction patterns even more effectively than ZIP.
    """
    lin_profits, gd_profits, efficiencies = run_exploitation_test(
        lin_is_buyer=True,
        exploiter_class=GD,
        exploiter_name="GD",
        num_sessions=10
    )

    avg_lin = np.mean(lin_profits)
    avg_gd = np.mean(gd_profits)
    avg_efficiency = np.mean(efficiencies)

    total_surplus = avg_lin + avg_gd
    lin_share = (avg_lin / total_surplus * 100) if total_surplus > 0 else 0
    gd_share = (avg_gd / total_surplus * 100) if total_surplus > 0 else 0

    gd_dominance = avg_gd / avg_lin if avg_lin > 0 else 0

    print(f"\n{'='*60}")
    print(f"LIN BUYERS vs GD SELLERS - Exploitation Test")
    print(f"{'='*60}")
    print(f"Lin Profit:      {avg_lin:.0f} ({lin_share:.1f}%)")
    print(f"GD Profit:       {avg_gd:.0f} ({gd_share:.1f}%)")
    print(f"Efficiency:      {avg_efficiency:.1f}%")
    print(f"GD Dominance:    {gd_dominance:.2f}x")
    print(f"\nComparison to ZIC baseline:")
    print(f"  ZIC extracted:  34.5% from Lin buyers")
    print(f"  GD extracted:   {gd_share:.1f}% from Lin buyers")
    if gd_share > 35:
        print(f"  Result: GD EXPLOITS Lin ({gd_share-34.5:.1f}% more than ZIC)")
    elif gd_share > 30:
        print(f"  Result: GD competitive with ZIC")
    else:
        print(f"  Result: Lin holds ground against GD")
    print(f"{'='*60}\n")

    # GD should extract at least as much as ZIC did (34.5%)
    assert gd_share >= 30, \
        f"GD share {gd_share:.1f}% unexpectedly low (expected >= 30%)"


def test_lin_exploited_by_gd_as_sellers():
    """
    Test that GD exploits Lin sellers.

    Expected: GD should extract comparable or greater profit than ZIC.
    """
    lin_profits, gd_profits, efficiencies = run_exploitation_test(
        lin_is_buyer=False,
        exploiter_class=GD,
        exploiter_name="GD",
        num_sessions=10
    )

    avg_lin = np.mean(lin_profits)
    avg_gd = np.mean(gd_profits)
    avg_efficiency = np.mean(efficiencies)

    total_surplus = avg_lin + avg_gd
    lin_share = (avg_lin / total_surplus * 100) if total_surplus > 0 else 0
    gd_share = (avg_gd / total_surplus * 100) if total_surplus > 0 else 0

    gd_dominance = avg_gd / avg_lin if avg_lin > 0 else 0

    print(f"\n{'='*60}")
    print(f"GD BUYERS vs LIN SELLERS - Exploitation Test")
    print(f"{'='*60}")
    print(f"GD Profit:       {avg_gd:.0f} ({gd_share:.1f}%)")
    print(f"Lin Profit:      {avg_lin:.0f} ({lin_share:.1f}%)")
    print(f"Efficiency:      {avg_efficiency:.1f}%")
    print(f"GD Dominance:    {gd_dominance:.2f}x")
    print(f"\nComparison to ZIC baseline:")
    print(f"  ZIC extracted:  49.4% from Lin sellers")
    print(f"  GD extracted:   {gd_share:.1f}% from Lin sellers")
    if gd_share > 50:
        print(f"  Result: GD EXPLOITS Lin ({gd_share-49.4:.1f}% more than ZIC)")
    elif gd_share > 45:
        print(f"  Result: GD competitive with ZIC")
    else:
        print(f"  Result: Lin holds ground against GD")
    print(f"{'='*60}\n")

    # GD should extract at least as much as ZIC did (~49%)
    assert gd_share >= 40, \
        f"GD share {gd_share:.1f}% unexpectedly low (expected >= 40%)"


def test_lin_variance_against_sophisticated_traders():
    """
    Test that Lin shows high variance against sophisticated traders.

    This validates that Lin's performance depends heavily on market conditions,
    explaining the poor tournament finish despite excellent self-play efficiency.
    """
    # Run multiple seeds to measure variance
    zip_shares_as_buyer = []
    zip_shares_as_seller = []

    for seed_offset in range(5):
        # Lin as buyer vs ZIP
        lin_profits, zip_profits, _ = run_exploitation_test(
            lin_is_buyer=True,
            exploiter_class=ZIP,
            exploiter_name="ZIP",
            num_sessions=5,
            beta=0.2,
            gamma=0.25,
            initial_margin_buy=-0.30,
            initial_margin_sell=0.30
        )
        total = np.mean(lin_profits) + np.mean(zip_profits)
        lin_share_buyer = (np.mean(lin_profits) / total * 100) if total > 0 else 0
        zip_shares_as_buyer.append(100 - lin_share_buyer)

        # Lin as seller vs ZIP
        lin_profits, zip_profits, _ = run_exploitation_test(
            lin_is_buyer=False,
            exploiter_class=ZIP,
            exploiter_name="ZIP",
            num_sessions=5,
            beta=0.2,
            gamma=0.25,
            initial_margin_buy=-0.30,
            initial_margin_sell=0.30
        )
        total = np.mean(lin_profits) + np.mean(zip_profits)
        lin_share_seller = (np.mean(lin_profits) / total * 100) if total > 0 else 0
        zip_shares_as_seller.append(100 - lin_share_seller)

    buyer_variance = np.std(zip_shares_as_buyer)
    seller_variance = np.std(zip_shares_as_seller)

    print(f"\n{'='*60}")
    print(f"LIN VARIANCE AGAINST ZIP - Stability Test")
    print(f"{'='*60}")
    print(f"ZIP extraction from Lin buyers:")
    print(f"  Mean: {np.mean(zip_shares_as_buyer):.1f}%")
    print(f"  Std:  {buyer_variance:.1f}%")
    print(f"  Range: {np.min(zip_shares_as_buyer):.1f}% - {np.max(zip_shares_as_buyer):.1f}%")
    print(f"\nZIP extraction from Lin sellers:")
    print(f"  Mean: {np.mean(zip_shares_as_seller):.1f}%")
    print(f"  Std:  {seller_variance:.1f}%")
    print(f"  Range: {np.min(zip_shares_as_seller):.1f}% - {np.max(zip_shares_as_seller):.1f}%")
    print(f"\nConclusion:")
    if buyer_variance > 10 or seller_variance > 10:
        print(f"  HIGH VARIANCE confirms Lin's unreliable performance")
        print(f"  This explains 26th place despite 99.85% self-play efficiency")
    else:
        print(f"  Low variance suggests consistent performance")
    print(f"{'='*60}\n")

    # Document that variance exists (exact threshold is exploratory)
    # High variance (>10%) would indicate instability
    print(f"\n**KEY FINDING:** Lin shows variance of {buyer_variance:.1f}% (buyer) "
          f"and {seller_variance:.1f}% (seller) against sophisticated traders")
